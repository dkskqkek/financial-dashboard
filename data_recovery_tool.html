<!DOCTYPE html>
<html>
<head>
    <title>📊 Financial Dashboard - 데이터 복구 도구</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f8f9fa; }
        .container { max-width: 1000px; margin: 0 auto; }
        .recovery-section { margin: 20px 0; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .button { padding: 12px 20px; margin: 8px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .button:hover { background: #0056b3; }
        .danger { background: #dc3545; }
        .danger:hover { background: #c82333; }
        .success { background: #28a745; }
        .success:hover { background: #218838; }
        .result { background: #e9f7ef; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #17a2b8; }
        .code-block { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px; border: 1px solid #e9ecef; }
        pre { margin: 0; white-space: pre-wrap; word-wrap: break-word; }
        .recovery-steps { background: #fff3cd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Financial Dashboard - 데이터 복구 도구</h1>
        
        <div class="recovery-steps">
            <h3>🚨 데이터 복구 단계</h3>
            <ol>
                <li><strong>현재 상태 확인</strong> → localStorage 데이터 검사</li>
                <li><strong>백업 데이터 검색</strong> → 가능한 복구 소스 찾기</li>
                <li><strong>수동 복구</strong> → 테스트 데이터로 시스템 확인</li>
                <li><strong>실제 데이터 복구</strong> → 실제 주식 정보 입력</li>
            </ol>
        </div>

        <!-- 1단계: 현재 상태 확인 -->
        <div class="recovery-section">
            <h2>🔍 1단계: 현재 localStorage 상태 확인</h2>
            <button class="button" onclick="checkCurrentState()">현재 상태 검사</button>
            <button class="button" onclick="searchBackupKeys()">백업 키 검색</button>
            <div id="current-state-result"></div>
        </div>

        <!-- 2단계: 백업 데이터 검색 -->
        <div class="recovery-section">
            <h2>🔎 2단계: 백업 데이터 검색</h2>
            <button class="button" onclick="deepSearchBackups()">전체 localStorage 검색</button>
            <button class="button" onclick="exportAllData()">모든 데이터 내보내기</button>
            <div id="backup-search-result"></div>
        </div>

        <!-- 3단계: 테스트 복구 -->
        <div class="recovery-section">
            <h2>🧪 3단계: 테스트 데이터로 시스템 확인</h2>
            <button class="button success" onclick="createTestStockData()">테스트 주식 데이터 생성</button>
            <button class="button success" onclick="createTestCashData()">테스트 현금 계좌 생성</button>
            <button class="button success" onclick="createFullTestData()">전체 테스트 데이터 생성</button>
            <div id="test-recovery-result"></div>
        </div>

        <!-- 4단계: 실제 데이터 복구 -->
        <div class="recovery-section">
            <h2>📈 4단계: 실제 데이터 수동 입력</h2>
            <div class="info">
                <strong>📝 주식 정보를 기억나는 대로 입력하세요:</strong><br>
                - 보유 주식 종목명, 수량, 평균단가<br>
                - 현금 계좌 잔고<br>
                - 기타 자산 정보
            </div>
            <textarea id="manual-stock-input" placeholder="예시:
AAPL,10,150.00,USD,Apple Inc.
TSLA,5,200.00,USD,Tesla Inc.
005930,100,70000,KRW,삼성전자" style="width: 100%; height: 120px; margin: 10px 0; padding: 10px;"></textarea>
            <button class="button success" onclick="parseManualStockData()">주식 데이터 파싱 및 복구</button>
            
            <textarea id="manual-cash-input" placeholder="예시:
KB국민은행,5000000,KRW
Chase Checking,2000,USD" style="width: 100%; height: 80px; margin: 10px 0; padding: 10px;"></textarea>
            <button class="button success" onclick="parseManualCashData()">현금 계좌 데이터 복구</button>
            
            <div id="manual-recovery-result"></div>
        </div>

        <!-- 5단계: 복구 완료 -->
        <div class="recovery-section">
            <h2>✅ 5단계: 복구 완료 및 확인</h2>
            <button class="button success" onclick="finalCheck()">복구 완료 확인</button>
            <button class="button" onclick="goToApp()">앱으로 이동</button>
            <button class="button danger" onclick="clearAllData()">모든 데이터 삭제 (주의!)</button>
            <div id="final-result"></div>
        </div>
    </div>

    <script>
        function checkCurrentState() {
            const result = document.getElementById('current-state-result');
            const storeKey = 'financial-dashboard-store';
            const data = localStorage.getItem(storeKey);
            
            let html = '<div class="result"><h3>현재 상태 검사 결과:</h3>';
            
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    const stocks = parsed.state?.stocks || [];
                    const cashAccounts = parsed.state?.cashAccounts || [];
                    
                    html += `<p>✅ 스토어 발견! 주식: ${stocks.length}개, 계좌: ${cashAccounts.length}개</p>`;
                    
                    if (stocks.length > 0) {
                        html += '<p><strong>보유 주식:</strong></p><ul>';
                        stocks.forEach(stock => {
                            html += `<li>${stock.symbol} (${stock.name}): ${stock.quantity}주, 평균단가: ${stock.avgPrice}</li>`;
                        });
                        html += '</ul>';
                    } else {
                        html += '<p style="color: orange;">⚠️ 주식 데이터가 비어있습니다.</p>';
                    }
                    
                } catch (e) {
                    html += `<p style="color: red;">❌ 데이터 파싱 오류: ${e.message}</p>`;
                }
            } else {
                html += '<p style="color: red;">❌ financial-dashboard-store 키가 존재하지 않습니다.</p>';
            }
            
            html += '</div>';
            result.innerHTML = html;
        }

        function searchBackupKeys() {
            const result = document.getElementById('current-state-result');
            let html = '<div class="info"><h3>백업 키 검색 결과:</h3>';
            
            const allKeys = Object.keys(localStorage);
            const relevantKeys = allKeys.filter(key => 
                key.includes('financial') || 
                key.includes('dashboard') || 
                key.includes('backup') || 
                key.includes('store') ||
                key.includes('stock')
            );
            
            if (relevantKeys.length > 0) {
                html += '<p>✅ 관련 키 발견:</p><ul>';
                relevantKeys.forEach(key => {
                    html += `<li><strong>${key}</strong> (크기: ${localStorage.getItem(key)?.length || 0} 문자)</li>`;
                });
                html += '</ul>';
            } else {
                html += '<p style="color: red;">❌ 관련 백업 키를 찾을 수 없습니다.</p>';
            }
            
            html += '</div>';
            result.innerHTML += html;
        }

        function createTestStockData() {
            const testStocks = [
                {
                    id: "test-aapl-1",
                    symbol: "AAPL",
                    name: "Apple Inc.",
                    quantity: 10,
                    avgPrice: 150.00,
                    currentPrice: 175.00,
                    marketValue: 1750.00,
                    currency: "USD"
                },
                {
                    id: "test-tsla-1", 
                    symbol: "TSLA",
                    name: "Tesla Inc.",
                    quantity: 5,
                    avgPrice: 200.00,
                    currentPrice: 220.00,
                    marketValue: 1100.00,
                    currency: "USD"
                },
                {
                    id: "test-samsung-1",
                    symbol: "005930",
                    name: "삼성전자",
                    quantity: 100,
                    avgPrice: 70000,
                    currentPrice: 75000,
                    marketValue: 7500000,
                    currency: "KRW"
                }
            ];

            // 기존 데이터 가져오기 또는 새로 생성
            let existingData;
            try {
                const stored = localStorage.getItem('financial-dashboard-store');
                existingData = stored ? JSON.parse(stored) : { version: 0, state: {} };
            } catch (e) {
                existingData = { version: 0, state: {} };
            }

            // 주식 데이터 설정
            existingData.state.stocks = testStocks;
            
            localStorage.setItem('financial-dashboard-store', JSON.stringify(existingData));
            
            document.getElementById('test-recovery-result').innerHTML = 
                '<div class="result">✅ 테스트 주식 데이터 생성 완료! (Apple, Tesla, 삼성전자)</div>';
        }

        function createTestCashData() {
            const testCashAccounts = [
                {
                    id: "test-cash-krw-1",
                    name: "KB국민은행 입출금",
                    balance: 5000000,
                    currency: "KRW"
                },
                {
                    id: "test-cash-usd-1",
                    name: "Chase Checking",
                    balance: 3000,
                    currency: "USD"
                }
            ];

            let existingData;
            try {
                const stored = localStorage.getItem('financial-dashboard-store');
                existingData = stored ? JSON.parse(stored) : { version: 0, state: {} };
            } catch (e) {
                existingData = { version: 0, state: {} };
            }

            existingData.state.cashAccounts = testCashAccounts;
            
            localStorage.setItem('financial-dashboard-store', JSON.stringify(existingData));
            
            document.getElementById('test-recovery-result').innerHTML += 
                '<div class="result">✅ 테스트 현금 계좌 데이터 생성 완료! (KRW 500만원, USD $3,000)</div>';
        }

        function createFullTestData() {
            const fullTestData = {
                version: 0,
                state: {
                    user: {
                        id: "test-user-1",
                        name: "테스트 사용자",
                        email: "test@example.com"
                    },
                    stocks: [
                        {
                            id: "test-aapl-1",
                            symbol: "AAPL",
                            name: "Apple Inc.",
                            quantity: 10,
                            avgPrice: 150.00,
                            currentPrice: 175.00,
                            marketValue: 1750.00,
                            currency: "USD"
                        },
                        {
                            id: "test-tsla-1",
                            symbol: "TSLA", 
                            name: "Tesla Inc.",
                            quantity: 5,
                            avgPrice: 200.00,
                            currentPrice: 220.00,
                            marketValue: 1100.00,
                            currency: "USD"
                        }
                    ],
                    cashAccounts: [
                        {
                            id: "test-cash-krw-1",
                            name: "KB국민은행 입출금",
                            balance: 5000000,
                            currency: "KRW"
                        },
                        {
                            id: "test-cash-usd-1",
                            name: "Chase Checking",
                            balance: 3000,
                            currency: "USD"
                        }
                    ],
                    transactions: [],
                    stockTransactions: [],
                    dividends: [],
                    savings: [],
                    realEstate: [],
                    loans: [],
                    loanPayments: [],
                    isDarkMode: false,
                    selectedTimeRange: "1Y",
                    sidebarOpen: true,
                    financialData: null,
                    exchangeRate: null
                }
            };

            localStorage.setItem('financial-dashboard-store', JSON.stringify(fullTestData));
            
            document.getElementById('test-recovery-result').innerHTML = 
                '<div class="result">✅ 전체 테스트 데이터 생성 완료! 이제 앱에서 데이터를 확인해보세요.</div>';
        }

        function parseManualStockData() {
            const input = document.getElementById('manual-stock-input').value.trim();
            if (!input) {
                alert('주식 정보를 입력해주세요.');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim());
            const stocks = [];
            let id = 1;

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 4) {
                    const [symbol, quantity, avgPrice, currency, name] = parts;
                    stocks.push({
                        id: `manual-${symbol}-${id++}`,
                        symbol: symbol,
                        name: name || symbol,
                        quantity: parseFloat(quantity) || 0,
                        avgPrice: parseFloat(avgPrice) || 0,
                        currentPrice: parseFloat(avgPrice) || 0, // 일단 평균단가로 설정
                        marketValue: (parseFloat(quantity) || 0) * (parseFloat(avgPrice) || 0),
                        currency: currency || 'USD'
                    });
                }
            });

            if (stocks.length > 0) {
                let existingData;
                try {
                    const stored = localStorage.getItem('financial-dashboard-store');
                    existingData = stored ? JSON.parse(stored) : { version: 0, state: {} };
                } catch (e) {
                    existingData = { version: 0, state: {} };
                }

                existingData.state.stocks = stocks;
                localStorage.setItem('financial-dashboard-store', JSON.stringify(existingData));
                
                document.getElementById('manual-recovery-result').innerHTML = 
                    `<div class="result">✅ ${stocks.length}개 주식 데이터가 복구되었습니다!</div>`;
            } else {
                document.getElementById('manual-recovery-result').innerHTML = 
                    '<div class="error">❌ 유효한 주식 데이터를 파싱할 수 없습니다.</div>';
            }
        }

        function parseManualCashData() {
            const input = document.getElementById('manual-cash-input').value.trim();
            if (!input) {
                alert('계좌 정보를 입력해주세요.');
                return;
            }

            const lines = input.split('\n').filter(line => line.trim());
            const cashAccounts = [];
            let id = 1;

            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim());
                if (parts.length >= 3) {
                    const [name, balance, currency] = parts;
                    cashAccounts.push({
                        id: `manual-cash-${id++}`,
                        name: name,
                        balance: parseFloat(balance) || 0,
                        currency: currency || 'KRW'
                    });
                }
            });

            if (cashAccounts.length > 0) {
                let existingData;
                try {
                    const stored = localStorage.getItem('financial-dashboard-store');
                    existingData = stored ? JSON.parse(stored) : { version: 0, state: {} };
                } catch (e) {
                    existingData = { version: 0, state: {} };
                }

                existingData.state.cashAccounts = cashAccounts;
                localStorage.setItem('financial-dashboard-store', JSON.stringify(existingData));
                
                document.getElementById('manual-recovery-result').innerHTML += 
                    `<div class="result">✅ ${cashAccounts.length}개 계좌 데이터가 복구되었습니다!</div>`;
            }
        }

        function finalCheck() {
            const stored = localStorage.getItem('financial-dashboard-store');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    const stocks = data.state?.stocks || [];
                    const cash = data.state?.cashAccounts || [];
                    
                    let html = '<div class="result"><h3>복구 완료 확인:</h3>';
                    html += `<p>✅ 주식 데이터: ${stocks.length}개</p>`;
                    html += `<p>✅ 현금 계좌: ${cash.length}개</p>`;
                    html += '<p>📱 이제 앱을 새로고침해서 데이터를 확인해보세요!</p>';
                    html += '</div>';
                    
                    document.getElementById('final-result').innerHTML = html;
                } catch (e) {
                    document.getElementById('final-result').innerHTML = 
                        '<div class="error">❌ 데이터 검증 중 오류 발생</div>';
                }
            } else {
                document.getElementById('final-result').innerHTML = 
                    '<div class="error">❌ 복구된 데이터가 없습니다.</div>';
            }
        }

        function goToApp() {
            window.open('http://localhost:3000', '_blank');
        }

        function clearAllData() {
            if (confirm('정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다!')) {
                localStorage.removeItem('financial-dashboard-store');
                document.getElementById('final-result').innerHTML = 
                    '<div class="error">⚠️ 모든 데이터가 삭제되었습니다.</div>';
            }
        }

        // 페이지 로드시 현재 상태 자동 확인
        window.onload = function() {
            checkCurrentState();
        };
    </script>
</body>
</html>