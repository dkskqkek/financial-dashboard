import React, { useEffect, useState } from 'react'
import { useAppStore } from '@/stores'
import { apiService } from '@/services/api'
import { exchangeRateService } from '@/services/exchangeRateService'
import { yahooFinanceService } from '@/services/yahooFinance'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog'
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table'
import {
  LineChart,
  Line,
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from 'recharts'
import {
  Plus,
  Search,
  TrendingUp,
  TrendingDown,
  DollarSign,
  PieChart as PieIcon,
  BarChart3,
  RefreshCw,
  Edit,
  Trash2,
} from 'lucide-react'
import { AddStockTransactionForm } from '@/components/forms/AddStockTransactionForm'
import { StockDisplayCell } from '@/components/StockDisplayCell'
import { StockWeightDisplay } from '@/components/StockWeightDisplay'
import { StockWeightCell } from '@/components/StockWeightCell'
import { formatCurrency, formatPercent, getColorByValue } from '@/lib/utils'
import type { Stock } from '@/types'

export function StocksPage() {
  const {
    stocks,
    setStocks,
    deleteStock,
    updateStock,
    isLoading,
    setIsLoading,
    exchangeRate,
    updateExchangeRate,
    convertStockValueToKrw,
  } = useAppStore()
  const [searchTerm, setSearchTerm] = useState('')
  const [selectedExchange, setSelectedExchange] = useState<string>('all')
  const [editModalOpen, setEditModalOpen] = useState(false)
  const [editingStock, setEditingStock] = useState<Stock | null>(null)
  const [editFormData, setEditFormData] = useState({
    name: '',
    quantity: '',
    averagePrice: '',
    sector: '',
  })
  const [selectedSector, setSelectedSector] = useState<string>('all')
  const [totalMarketValueKrw, setTotalMarketValueKrw] = useState<number>(0)
  const [totalUnrealizedPnLKrw, setTotalUnrealizedPnLKrw] = useState<number>(0)
  const [sortedStocksKrw, setSortedStocksKrw] = useState<{ stock: Stock; krwValue: number }[]>([])

  // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÌôòÏú® ÏóÖÎç∞Ïù¥Ìä∏ Î∞è Ï¥ù Í∏àÏï° Í≥ÑÏÇ∞
  useEffect(() => {
    const initializeData = async () => {
      // ÌôòÏú® ÏóÖÎç∞Ïù¥Ìä∏
      if (!exchangeRate) {
        await updateExchangeRate()
      }

      // Ï¥ù Í∏àÏï° Í≥ÑÏÇ∞ (ÌôòÏú® Î≥ÄÌôò Ï†ÅÏö©)
      updateStockTotals(stocks)
    }

    initializeData()
  }, [])

  const updateStockTotals = React.useCallback(
    async (stocksToCalculate: Stock[]) => {
      if (!stocksToCalculate || stocksToCalculate.length === 0) {
        setTotalMarketValueKrw(0)
        setTotalUnrealizedPnLKrw(0)
        return
      }

      try {
        let totalMarketValue = 0
        let totalUnrealizedPnL = 0

        for (const stock of stocksToCalculate) {
          const marketValueKrw = await convertStockValueToKrw(stock)
          totalMarketValue += marketValueKrw

          // ÏÜêÏùµÎèÑ ÌôòÏú® Ï†ÅÏö©
          if (stock.currency === 'USD') {
            const unrealizedPnLKrw = await exchangeRateService.convertUsdToKrw(stock.unrealizedPnL)
            totalUnrealizedPnL += unrealizedPnLKrw
          } else {
            totalUnrealizedPnL += stock.unrealizedPnL
          }
        }

        setTotalMarketValueKrw(totalMarketValue)
        setTotalUnrealizedPnLKrw(totalUnrealizedPnL)
      } catch (error) {
        console.error('Ï¥ùÏï° Í≥ÑÏÇ∞ Ïã§Ìå®:', error)
      }
    },
    [convertStockValueToKrw]
  )

  // Ï£ºÏãù Îç∞Ïù¥ÌÑ∞Í∞Ä Î≥ÄÍ≤ΩÎê† ÎïåÎßàÎã§ Ï¥ù Í∏àÏï° Ïû¨Í≥ÑÏÇ∞ (ÎîîÎ∞îÏö¥Ïã±)
  useEffect(() => {
    const timeoutId = setTimeout(() => {
      const filteredStocks = (stocks || []).filter(stock => {
        const matchesSearch =
          stock.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          stock.symbol.toLowerCase().includes(searchTerm.toLowerCase())

        const matchesExchange = selectedExchange === 'all' || stock.exchange === selectedExchange
        const matchesSector = selectedSector === 'all' || stock.sector === selectedSector

        return matchesSearch && matchesExchange && matchesSector
      })
      updateStockTotals(filteredStocks)
    }, 300)
    return () => clearTimeout(timeoutId)
  }, [stocks, searchTerm, selectedExchange, selectedSector, updateStockTotals])

  // Í∞úÎ≥Ñ Ï£ºÏãù ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò
  const updateIndividualStockPrices = async () => {
    console.log('üîÑ Í∞úÎ≥Ñ Ï£ºÏãù ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏãúÏûë')
    const updatedStocks = [...stocks]
    let updateCount = 0

    for (let i = 0; i < updatedStocks.length; i++) {
      const stock = updatedStocks[i]
      try {
        // Yahoo Finance APIÎ°ú ÌòÑÏû¨ Ï£ºÍ∞Ä Ï°∞Ìöå
        const quotes = await yahooFinanceService.getQuotes([stock.symbol])
        if (quotes && quotes.length > 0 && quotes[0].regularMarketPrice) {
          const oldPrice = stock.currentPrice
          const currentPrice = quotes[0].regularMarketPrice
          updatedStocks[i] = {
            ...stock,
            currentPrice: currentPrice,
            marketValue: stock.quantity * currentPrice,
            unrealizedPnL: (currentPrice - stock.averagePrice) * stock.quantity,
            lastUpdated: new Date().toISOString(),
          }
          console.log(`‚úÖ ${stock.symbol}: ${oldPrice} ‚Üí ${currentPrice}`)
          updateCount++
        }
      } catch (error) {
        console.warn(`‚ùå ${stock.symbol} ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:`, error)
      }
    }

    if (updateCount > 0) {
      setStocks(updatedStocks)
      console.log(`‚úÖ ${updateCount}Í∞ú Ï£ºÏãù ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏ ÏôÑÎ£å`)
      alert(`${updateCount}Í∞ú Ï£ºÏãùÏùò ÏãúÏÑ∏Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§.`)
    } else {
      console.warn('‚ö†Ô∏è ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏Îêú Ï£ºÏãùÏù¥ ÏóÜÏäµÎãàÎã§')
      alert('ÏãúÏÑ∏Î•º ÏóÖÎç∞Ïù¥Ìä∏Ìï† Ïàò ÏóÜÏóàÏäµÎãàÎã§.')
    }
  }

  const loadStocks = async () => {
    setIsLoading(true)
    try {
      const stockData = await apiService.getStocks()
      console.log('üìä APIÏóêÏÑú Î∞õÏùÄ Ï£ºÏãù Îç∞Ïù¥ÌÑ∞:', stockData)

      // APIÏóêÏÑú Ïú†Ìö®Ìïú Îç∞Ïù¥ÌÑ∞Î•º Î∞õÏïòÏùÑ ÎïåÎßå ÏóÖÎç∞Ïù¥Ìä∏
      if (stockData && stockData.length > 0) {
        console.log('‚úÖ Ïú†Ìö®Ìïú Ï£ºÏãù Îç∞Ïù¥ÌÑ∞Î°ú ÏóÖÎç∞Ïù¥Ìä∏:', stockData.length, 'Í∞ú')
        setStocks(stockData)
      } else {
        console.warn('‚ö†Ô∏è APIÏóêÏÑú Îπà Îç∞Ïù¥ÌÑ∞ Î∞òÌôò - Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Ïùò ÏãúÏÑ∏Îßå Í∞úÎ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏')
        // Í∏∞Ï°¥ Ï£ºÏãùÎì§Ïùò ÏãúÏÑ∏Î•º Í∞úÎ≥ÑÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
        await updateIndividualStockPrices()
      }
    } catch (error) {
      console.error('‚ùå ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®:', error)
      alert('ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞Î•º Ïú†ÏßÄÌï©ÎãàÎã§.')
    } finally {
      setIsLoading(false)
    }
  }

  // Ï£ºÏãù ÏàòÏ†ï Î™®Îã¨ Ïó¥Í∏∞
  const handleEditStock = (stock: Stock) => {
    setEditingStock(stock)
    setEditFormData({
      name: stock.name,
      quantity: stock.quantity.toString(),
      averagePrice: stock.averagePrice.toString(),
      sector: stock.sector,
    })
    setEditModalOpen(true)
  }

  // Ï£ºÏãù ÏàòÏ†ï Ï†ÄÏû•
  const handleSaveEdit = () => {
    if (!editingStock) {
      return
    }

    const updatedStock = {
      ...editingStock,
      name: editFormData.name,
      quantity: Number(editFormData.quantity),
      averagePrice: Number(editFormData.averagePrice),
      sector: editFormData.sector,
      marketValue: Number(editFormData.quantity) * editingStock.currentPrice,
      unrealizedPnL: (editingStock.currentPrice - Number(editFormData.averagePrice)) * Number(editFormData.quantity),
    }

    updateStock(editingStock.id, updatedStock)
    setEditModalOpen(false)
    setEditingStock(null)
  }

  // ÏàòÏ†ï Î™®Îã¨ Îã´Í∏∞
  const handleCancelEdit = () => {
    setEditModalOpen(false)
    setEditingStock(null)
    setEditFormData({
      name: '',
      quantity: '',
      averagePrice: '',
      sector: '',
    })
  }

  const filteredStocks = (stocks || []).filter(stock => {
    const matchesSearch =
      stock.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      stock.symbol.toLowerCase().includes(searchTerm.toLowerCase())

    const matchesExchange = selectedExchange === 'all' || stock.exchange === selectedExchange
    const matchesSector = selectedSector === 'all' || stock.sector === selectedSector

    return matchesSearch && matchesExchange && matchesSector
  })

  // Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞ (KRW Î≥ÄÌôò Ï†ÅÏö©)
  const totalCost = totalMarketValueKrw - totalUnrealizedPnLKrw
  const totalReturn = totalCost !== 0 ? (totalUnrealizedPnLKrw / totalCost) * 100 : 0

  // ÏÑπÌÑ∞Î≥Ñ Î∂ÑÏÑù (ÌôòÏú® Î≥ÄÌôò Ï†ÅÏö©)
  const [sectorData, setSectorData] = useState<Record<string, number>>({})
  const [exchangeData, setExchangeData] = useState<Record<string, number>>({})

  // ÏÑπÌÑ∞/Í±∞ÎûòÏÜåÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ (ÌôòÏú® Î≥ÄÌôò Ï†ÅÏö©) - ÎîîÎ∞îÏö¥Ïã± Ï†ÅÏö©
  useEffect(() => {
    const timeoutId = setTimeout(async () => {
      const filteredStocks = (stocks || []).filter(stock => {
        const matchesSearch =
          stock.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          stock.symbol.toLowerCase().includes(searchTerm.toLowerCase())

        const matchesExchange = selectedExchange === 'all' || stock.exchange === selectedExchange
        const matchesSector = selectedSector === 'all' || stock.sector === selectedSector

        return matchesSearch && matchesExchange && matchesSector
      })

      if (filteredStocks.length === 0) {
        setSectorData({})
        setExchangeData({})
        setSortedStocksKrw([])
        return
      }

      try {
        const newSectorData: Record<string, number> = {}
        const newExchangeData: Record<string, number> = {}
        const stocksWithKrwValue: { stock: Stock; krwValue: number }[] = []

        for (const stock of filteredStocks) {
          const stockValueKrw = await convertStockValueToKrw(stock)

          // Ï†ïÎ†¨Ïö© Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
          stocksWithKrwValue.push({ stock, krwValue: stockValueKrw })

          // ÏÑπÌÑ∞Î≥Ñ Ìï©Í≥Ñ
          newSectorData[stock.sector] = (newSectorData[stock.sector] || 0) + stockValueKrw

          // Í±∞ÎûòÏÜåÎ≥Ñ Ìï©Í≥Ñ
          newExchangeData[stock.exchange] = (newExchangeData[stock.exchange] || 0) + stockValueKrw
        }

        // KRW Í∞ÄÏπò Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
        stocksWithKrwValue.sort((a, b) => b.krwValue - a.krwValue)
        setSortedStocksKrw(stocksWithKrwValue)

        setSectorData(newSectorData)
        setExchangeData(newExchangeData)
      } catch (error) {
        console.error('ÏÑπÌÑ∞/Í±∞ÎûòÏÜå Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ Ïã§Ìå®:', error)
      }
    }, 200) // 200ms ÎîîÎ∞îÏö¥Ïã±

    return () => clearTimeout(timeoutId)
  }, [stocks, searchTerm, selectedExchange, selectedSector, exchangeRate?.USD_KRW, convertStockValueToKrw])

  const sectorChartData = Object.entries(sectorData).map(([sector, value]) => ({
    name: sector,
    value,
  }))

  const COLORS = ['#1E3A8A', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4']

  const sectors = Array.from(new Set(stocks.map(s => s.sector)))
  const exchanges = Array.from(new Set(stocks.map(s => s.exchange)))

  return (
    <div className="space-y-6 p-6">
      {/* Ìó§Îçî */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">Ï£ºÏãù Ìè¨Ìä∏Ìè¥Î¶¨Ïò§</h1>
          <p className="text-muted-foreground">Î≥¥Ïú† Ï£ºÏãùÍ≥º Ìà¨Ïûê ÏÑ±Í≥ºÎ•º Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî</p>
        </div>

        <div className="flex items-center space-x-2">
          <Button variant="outline" onClick={loadStocks} disabled={isLoading}>
            <RefreshCw className={`h-4 w-4 mr-2 ${isLoading ? 'animate-spin' : ''}`} />
            ÏãúÏÑ∏ ÏóÖÎç∞Ïù¥Ìä∏
          </Button>
          <Button
            variant="outline"
            onClick={updateExchangeRate}
            title={`ÌòÑÏû¨ ÌôòÏú®: ${exchangeRate?.USD_KRW ? `$1 = ‚Ç©${exchangeRate.USD_KRW.toFixed(0)}` : 'Î°úÎî©Ï§ë'}`}
          >
            <DollarSign className="h-4 w-4 mr-2" />
            ÌôòÏú® ÏÉàÎ°úÍ≥†Ïπ®
          </Button>
          <AddStockTransactionForm />
        </div>
      </div>

      {/* Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ ÏöîÏïΩ Ïπ¥ÎìúÎì§ */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Ï¥ù ÌèâÍ∞ÄÍ∏àÏï°</CardTitle>
            <DollarSign className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold currency">{formatCurrency(totalMarketValueKrw)}</div>
            <p className="text-xs text-muted-foreground">{filteredStocks.length}Í∞ú Ï¢ÖÎ™©</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ÌèâÍ∞ÄÏÜêÏùµ</CardTitle>
            {totalUnrealizedPnLKrw > 0 ? (
              <TrendingUp className="h-4 w-4 text-success" />
            ) : (
              <TrendingDown className="h-4 w-4 text-destructive" />
            )}
          </CardHeader>
          <CardContent>
            <div className={`text-2xl font-bold currency ${getColorByValue(totalUnrealizedPnLKrw)}`}>
              {formatCurrency(totalUnrealizedPnLKrw)}
            </div>
            <p className={`text-xs ${getColorByValue(totalReturn)}`}>{formatPercent(totalReturn)}</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">Ìà¨ÏûêÏõêÍ∏à</CardTitle>
            <BarChart3 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold currency">{formatCurrency(totalCost)}</div>
            <p className="text-xs text-muted-foreground">Îß§Ïàò Í∏∞Ï§Ä</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">ÏàòÏùµÎ•†</CardTitle>
            <PieIcon className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className={`text-2xl font-bold ${getColorByValue(totalReturn)}`}>{formatPercent(totalReturn)}</div>
            <p className="text-xs text-muted-foreground">Ïó∞ÌôòÏÇ∞ Í∏∞Ï§Ä</p>
          </CardContent>
        </Card>
      </div>

      {/* Ï∞®Ìä∏ ÏÑπÏÖò */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>ÏÑπÌÑ∞Î≥Ñ Î∂ÑÏÇ∞</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="h-64">
              <ResponsiveContainer width="100%" height="100%">
                <PieChart>
                  <Pie
                    data={sectorChartData}
                    cx="50%"
                    cy="50%"
                    outerRadius={80}
                    fill="#8884d8"
                    dataKey="value"
                    label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                  >
                    {sectorChartData.map((entry, index) => (
                      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                    ))}
                  </Pie>
                  <Tooltip formatter={value => formatCurrency(value as number)} />
                </PieChart>
              </ResponsiveContainer>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Î≥¥Ïú† ÎπÑÏ§ë Top 5</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {sortedStocksKrw.slice(0, 5).map(({ stock }) => {
                return (
                  <div key={stock.id} className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <div className="w-8 h-8 bg-primary/10 rounded-full flex items-center justify-center">
                        <span className="text-xs font-medium">{stock.symbol.slice(0, 2)}</span>
                      </div>
                      <div>
                        <p className="font-medium text-sm">{stock.name}</p>
                        <p className="text-xs text-muted-foreground">{stock.symbol}</p>
                      </div>
                    </div>
                    <StockWeightDisplay
                      stock={stock}
                      totalMarketValueKrw={totalMarketValueKrw}
                      convertStockValueToKrw={convertStockValueToKrw}
                    />
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Î≥¥Ïú† Ï¢ÖÎ™© Î™©Î°ù */}
      <Card>
        <CardHeader>
          <CardTitle>Î≥¥Ïú† Ï¢ÖÎ™©</CardTitle>
          <div className="flex flex-col sm:flex-row gap-4">
            <div className="relative flex-1">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
              <Input
                placeholder="Ï¢ÖÎ™©Î™Ö, Ïã¨Î≥ºÎ°ú Í≤ÄÏÉâ..."
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                className="pl-10"
              />
            </div>
            <div className="flex gap-2">
              <select
                value={selectedExchange}
                onChange={e => setSelectedExchange(e.target.value)}
                className="px-3 py-1 border rounded-md text-sm"
              >
                <option value="all">Î™®Îì† Í±∞ÎûòÏÜå</option>
                {exchanges.map(exchange => (
                  <option key={exchange} value={exchange}>
                    {exchange}
                  </option>
                ))}
              </select>

              <select
                value={selectedSector}
                onChange={e => setSelectedSector(e.target.value)}
                className="px-3 py-1 border rounded-md text-sm"
              >
                <option value="all">Î™®Îì† ÏÑπÌÑ∞</option>
                {sectors.map(sector => (
                  <option key={sector} value={sector}>
                    {sector}
                  </option>
                ))}
              </select>
            </div>
          </div>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Ï¢ÖÎ™©Î™Ö</TableHead>
                <TableHead className="text-right">Î≥¥Ïú†ÏàòÎüâ</TableHead>
                <TableHead className="text-right">ÌèâÍ∑†Îß§ÏàòÍ∞Ä</TableHead>
                <TableHead className="text-right">ÌòÑÏû¨Í∞Ä</TableHead>
                <TableHead className="text-right">ÌèâÍ∞ÄÍ∏àÏï°</TableHead>
                <TableHead className="text-right">ÌèâÍ∞ÄÏÜêÏùµ</TableHead>
                <TableHead className="text-right">ÏàòÏùµÎ•†</TableHead>
                <TableHead className="text-right">ÎπÑÏ§ë</TableHead>
                <TableHead>ÏÑπÌÑ∞</TableHead>
                <TableHead>Í±∞ÎûòÏÜå</TableHead>
                <TableHead className="text-center">Í¥ÄÎ¶¨</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {(sortedStocksKrw.length > 0 ? sortedStocksKrw.map(({ stock }) => stock) : filteredStocks).map(stock => {
                const returnRate = ((stock.currentPrice - stock.averagePrice) / stock.averagePrice) * 100
                // weight Í≥ÑÏÇ∞ÏùÄ StockWeightCellÏóêÏÑú Ï≤òÎ¶¨

                return (
                  <TableRow key={stock.id} className="hover:bg-muted/50">
                    <TableCell>
                      <div>
                        <p className="font-medium">{stock.name}</p>
                        <p className="text-xs text-muted-foreground">{stock.symbol}</p>
                      </div>
                    </TableCell>
                    <TableCell className="text-right font-mono">{stock.quantity.toLocaleString()}</TableCell>
                    <TableCell className="text-right font-mono">
                      <StockDisplayCell value={stock.averagePrice} currency={stock.currency} />
                    </TableCell>
                    <TableCell className="text-right font-mono">
                      <div>
                        <p>
                          <StockDisplayCell value={stock.currentPrice} currency={stock.currency} />
                        </p>
                        <p className={`text-xs ${getColorByValue(stock.dailyChange)}`}>
                          {stock.dailyChange > 0 ? '+' : ''}
                          <StockDisplayCell value={stock.dailyChange} currency={stock.currency} />(
                          {formatPercent(stock.dailyChangePercent)})
                        </p>
                      </div>
                    </TableCell>
                    <TableCell className="text-right font-mono">
                      <StockDisplayCell value={stock.marketValue} currency={stock.currency} />
                    </TableCell>
                    <TableCell className={`text-right font-mono ${getColorByValue(stock.unrealizedPnL)}`}>
                      <StockDisplayCell value={stock.unrealizedPnL} currency={stock.currency} />
                    </TableCell>
                    <TableCell className={`text-right font-mono ${getColorByValue(returnRate)}`}>
                      {formatPercent(returnRate)}
                    </TableCell>
                    <TableCell className="text-right">
                      <StockWeightCell
                        stock={stock}
                        totalMarketValueKrw={totalMarketValueKrw}
                        convertStockValueToKrw={convertStockValueToKrw}
                      />
                    </TableCell>
                    <TableCell>
                      <Badge variant="outline">{stock.sector}</Badge>
                    </TableCell>
                    <TableCell>
                      <Badge variant={stock.exchange === 'KRX' ? 'default' : 'secondary'}>{stock.exchange}</Badge>
                    </TableCell>
                    <TableCell className="text-center">
                      <div className="flex justify-center space-x-1">
                        <Button variant="ghost" size="sm" onClick={() => handleEditStock(stock)}>
                          <Edit className="h-4 w-4" />
                        </Button>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => {
                            if (window.confirm(`${stock.name} Ï£ºÏãùÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                              deleteStock(stock.id)
                            }
                          }}
                          className="text-destructive hover:text-destructive"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </TableCell>
                  </TableRow>
                )
              })}
            </TableBody>
          </Table>

          {filteredStocks.length === 0 && (
            <div className="text-center py-12">
              <TrendingUp className="mx-auto h-12 w-12 text-muted-foreground" />
              <p className="mt-4 text-lg font-medium text-muted-foreground">Î≥¥Ïú† Ï£ºÏãùÏù¥ ÏóÜÏäµÎãàÎã§</p>
              <p className="text-sm text-muted-foreground">Ï≤´ Î≤àÏß∏ Ï£ºÏãù Ìà¨ÏûêÎ•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî</p>
              <Button
                className="mt-4"
                onClick={() => {
                  // AddStockTransactionFormÏùò Ìä∏Î¶¨Í±∞ Î≤ÑÌäºÏùÑ Ï∞æÏïÑÏÑú ÌÅ¥Î¶≠
                  const addButton = document.querySelector('[data-testid="add-stock-trigger"]') as HTMLButtonElement
                  if (addButton) {
                    addButton.click()
                  } else {
                    // ÎåÄÏïà: ÏßÅÏ†ë ÏïåÎ¶º
                    alert('Ï£ºÏãù Ï∂îÍ∞Ä Í∏∞Îä•ÏùÑ ÏÇ¨Ïö©ÌïòÎ†§Î©¥ ÏÉÅÎã®Ïùò "Îß§Îß§ Í∏∞Î°ù" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî.')
                  }
                }}
              >
                <Plus className="h-4 w-4 mr-2" />
                Îß§Ïàò Í∏∞Î°ù Ï∂îÍ∞Ä
              </Button>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Ìè¨Ìä∏Ìè¥Î¶¨Ïò§ Î∂ÑÏÑù */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Í±∞ÎûòÏÜåÎ≥Ñ Î∂ÑÏÇ∞</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {Object.entries(exchangeData).map(([exchange, value]) => {
                const percentage = totalMarketValueKrw > 0 ? (value / totalMarketValueKrw) * 100 : 0
                return (
                  <div key={exchange} className="flex items-center justify-between">
                    <div className="flex items-center space-x-2">
                      <div className="w-3 h-3 rounded-full bg-primary" />
                      <span className="font-medium">{exchange}</span>
                    </div>
                    <div className="text-right">
                      <p className="text-sm font-medium">{percentage.toFixed(1)}%</p>
                      <p className="text-xs text-muted-foreground currency">{formatCurrency(value)}</p>
                    </div>
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>ÏàòÏùµÎ•† Î∂ÑÌè¨</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {['20% Ïù¥ÏÉÅ', '10-20%', '0-10%', '0% ÎØ∏Îßå'].map((range, index) => {
                let count = 0
                if (range === '20% Ïù¥ÏÉÅ') {
                  count = filteredStocks.filter(s => {
                    const rate = ((s.currentPrice - s.averagePrice) / s.averagePrice) * 100
                    return rate >= 20
                  }).length
                } else if (range === '10-20%') {
                  count = filteredStocks.filter(s => {
                    const rate = ((s.currentPrice - s.averagePrice) / s.averagePrice) * 100
                    return rate >= 10 && rate < 20
                  }).length
                } else if (range === '0-10%') {
                  count = filteredStocks.filter(s => {
                    const rate = ((s.currentPrice - s.averagePrice) / s.averagePrice) * 100
                    return rate >= 0 && rate < 10
                  }).length
                } else {
                  count = filteredStocks.filter(s => {
                    const rate = ((s.currentPrice - s.averagePrice) / s.averagePrice) * 100
                    return rate < 0
                  }).length
                }

                return (
                  <div key={range} className="flex items-center justify-between">
                    <span className="text-sm">{range}</span>
                    <Badge variant="outline">{count}Ï¢ÖÎ™©</Badge>
                  </div>
                )
              })}
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Î¶¨Î∞∏Îü∞Ïã± Ï†úÏïà</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3 text-sm">
              <div className="p-3 bg-warning/10 rounded-lg">
                <p className="font-medium text-warning">‚ö† ÏßëÏ§ëÎèÑ ÏúÑÌóò</p>
                <p className="text-xs text-muted-foreground mt-1">ÏÉÅÏúÑ 3Ï¢ÖÎ™©Ïù¥ Ìè¨Ìä∏Ìè¥Î¶¨Ïò§Ïùò 60% Ïù¥ÏÉÅÏùÑ Ï∞®ÏßÄÌï©ÎãàÎã§</p>
              </div>

              <div className="p-3 bg-success/10 rounded-lg">
                <p className="font-medium text-success">‚úì ÏÑπÌÑ∞ Î∂ÑÏÇ∞ ÏñëÌò∏</p>
                <p className="text-xs text-muted-foreground mt-1">Îã§ÏñëÌïú ÏÑπÌÑ∞Ïóê Í≥†Î•¥Í≤å Î∂ÑÏÇ∞ÎêòÏñ¥ ÏûàÏäµÎãàÎã§</p>
              </div>

              <div className="p-3 bg-primary/10 rounded-lg">
                <p className="font-medium text-primary">üí° Ï∂îÏ≤ú</p>
                <p className="text-xs text-muted-foreground mt-1">Ìï¥Ïô∏ Ï£ºÏãù ÎπÑÏ§ëÏùÑ ÎäòÎ†§ ÏßÄÏó≠ Î∂ÑÏÇ∞ÏùÑ Í≥†Î†§Ìï¥Î≥¥ÏÑ∏Ïöî</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Ï£ºÏãù ÏàòÏ†ï Î™®Îã¨ */}
      <Dialog open={editModalOpen} onOpenChange={setEditModalOpen}>
        <DialogContent className="sm:max-w-[425px]">
          <DialogHeader>
            <DialogTitle>Ï£ºÏãù Ï†ïÎ≥¥ ÏàòÏ†ï</DialogTitle>
            <DialogDescription>Î≥¥Ïú† Ï£ºÏãùÏùò Ï†ïÎ≥¥Î•º ÏàòÏ†ïÌï† Ïàò ÏûàÏäµÎãàÎã§.</DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <label htmlFor="stockName" className="text-sm font-medium">
                Ï¢ÖÎ™©Î™Ö
              </label>
              <Input
                id="stockName"
                value={editFormData.name}
                onChange={e => setEditFormData({ ...editFormData, name: e.target.value })}
                placeholder="Ï¢ÖÎ™©Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              />
            </div>

            <div>
              <label htmlFor="quantity" className="text-sm font-medium">
                Î≥¥Ïú† ÏàòÎüâ
              </label>
              <Input
                id="quantity"
                type="number"
                value={editFormData.quantity}
                onChange={e => setEditFormData({ ...editFormData, quantity: e.target.value })}
                placeholder="Î≥¥Ïú† ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              />
            </div>

            <div>
              <label htmlFor="averagePrice" className="text-sm font-medium">
                ÌèâÍ∑† Îß§ÏûÖÍ∞Ä
              </label>
              <Input
                id="averagePrice"
                type="number"
                value={editFormData.averagePrice}
                onChange={e => setEditFormData({ ...editFormData, averagePrice: e.target.value })}
                placeholder="ÌèâÍ∑† Îß§ÏûÖÍ∞ÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
              />
            </div>

            <div>
              <label htmlFor="sector" className="text-sm font-medium">
                ÏÑπÌÑ∞
              </label>
              <select
                id="sector"
                value={editFormData.sector}
                onChange={e => setEditFormData({ ...editFormData, sector: e.target.value })}
                className="w-full mt-1 px-3 py-2 border rounded-md"
              >
                <option value="">ÏÑ†ÌÉùÏïàÌï®</option>
                <option value="Í∏∞Ïà†">Í∏∞Ïà†</option>
                <option value="Î∞òÎèÑÏ≤¥">Î∞òÎèÑÏ≤¥</option>
                <option value="ÏûêÎèôÏ∞®">ÏûêÎèôÏ∞®</option>
                <option value="Í∏àÏúµ">Í∏àÏúµ</option>
                <option value="Î∞îÏù¥Ïò§">Î∞îÏù¥Ïò§</option>
                <option value="ÏóêÎÑàÏßÄ">ÏóêÎÑàÏßÄ</option>
                <option value="ÏÜåÎπÑÏû¨">ÏÜåÎπÑÏû¨</option>
                <option value="Ìå®ÏãúÎ∏å">Ìå®ÏãúÎ∏å</option>
                <option value="Ï±ÑÍ∂å">Ï±ÑÍ∂å</option>
                <option value="Î¶¨Ï∏†">Î¶¨Ï∏†</option>
                <option value="ÏõêÏûêÏû¨">ÏõêÏûêÏû¨</option>
                <option value="Ìó¨Ïä§ÏºÄÏñ¥">Ìó¨Ïä§ÏºÄÏñ¥</option>
                <option value="ÌÜµÏã†">ÌÜµÏã†</option>
                <option value="Ïú†Ìã∏Î¶¨Ìã∞">Ïú†Ìã∏Î¶¨Ìã∞</option>
                <option value="Í∞ÄÏÉÅÌôîÌèê">Í∞ÄÏÉÅÌôîÌèê</option>
              </select>
            </div>
          </div>

          <div className="flex justify-end space-x-2 pt-4">
            <Button type="button" variant="outline" onClick={handleCancelEdit}>
              Ï∑®ÏÜå
            </Button>
            <Button type="button" onClick={handleSaveEdit}>
              Ï†ÄÏû•
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  )
}
