name: ðŸ” PR Auto Review & Quality Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  pull_request_review:
    types: [submitted]

env:
  NODE_VERSION: '20'
  CACHE_KEY_PREFIX: 'financial-dashboard'

jobs:
  # 1. ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  code-quality:
    name: ðŸ“‹ Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install Dependencies
        run: npm ci

      - name: ðŸ§¹ Lint Check
        run: |
          if [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f "eslint.config.js" ]; then
            npm run lint
          else
            echo "âš ï¸ ESLint ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ðŸŽ¨ Format Check
        run: |
          if [ -f ".prettierrc" ] || [ -f "prettier.config.js" ]; then
            npx prettier --check "src/**/*.{ts,tsx,js,jsx,css,md}"
          else
            echo "âš ï¸ Prettier ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ðŸ” TypeScript Check
        run: npx tsc --noEmit

  # 2. ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install Dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build Application
        run: npm run build

      - name: ðŸ§ª Run Tests
        run: |
          if [ -f "jest.config.js" ] || grep -q "test" package.json; then
            npm test -- --watchAll=false --coverage
          else
            echo "âš ï¸ í…ŒìŠ¤íŠ¸ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤."
          fi

      - name: ðŸ“Š Upload Coverage
        uses: codecov/codecov-action@v3
        if: success()
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # 3. ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: code-quality
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install Dependencies
        run: npm ci

      - name: ðŸ›¡ï¸ Audit Dependencies
        run: npm audit --audit-level moderate

      - name: ðŸ” CodeQL Analysis
        uses: github/codeql-action/init@v2
        with:
          languages: javascript

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2

  # 4. ì„±ëŠ¥ ê²€ì‚¬
  performance-check:
    name: âš¡ Performance Check
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ”§ Install Dependencies
        run: npm ci

      - name: ðŸ—ï¸ Build for Analysis
        run: npm run build

      - name: ðŸ“Š Bundle Size Check
        run: |
          echo "## ðŸ“Š Bundle Size Analysis" >> $GITHUB_STEP_SUMMARY
          echo "### ë¹Œë“œ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          ls -la dist/assets/ >> $GITHUB_STEP_SUMMARY || echo "ë¹Œë“œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

  # 5. PR ìžë™ ì½”ë©˜íŠ¸
  auto-comment:
    name: ðŸ’¬ Auto Comment
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test, security-scan, performance-check]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ’¬ Create PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;
            
            // ê° jobì˜ ê²°ê³¼ ìƒíƒœ í™•ì¸
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner,
              repo,
              run_id: context.runId,
            });
            
            const jobResults = {};
            jobs.data.jobs.forEach(job => {
              jobResults[job.name] = job.conclusion;
            });
            
            const createStatusIcon = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¸ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'ðŸ”„';
              }
            };
            
            const comment = `
            ## ðŸ¤– ìžë™ PR ê²€í†  ê²°ê³¼
            
            ### ðŸ“‹ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½
            
            | ê²€ì‚¬ í•­ëª© | ìƒíƒœ | ê²°ê³¼ |
            |-----------|------|------|
            | ì½”ë“œ í’ˆì§ˆ | ${createStatusIcon(jobResults['ðŸ“‹ Code Quality Check'])} | ${jobResults['ðŸ“‹ Code Quality Check'] || 'pending'} |
            | ë¹Œë“œ & í…ŒìŠ¤íŠ¸ | ${createStatusIcon(jobResults['ðŸ—ï¸ Build & Test'])} | ${jobResults['ðŸ—ï¸ Build & Test'] || 'pending'} |
            | ë³´ì•ˆ ê²€ì‚¬ | ${createStatusIcon(jobResults['ðŸ”’ Security Scan'])} | ${jobResults['ðŸ”’ Security Scan'] || 'pending'} |
            | ì„±ëŠ¥ ê²€ì‚¬ | ${createStatusIcon(jobResults['âš¡ Performance Check'])} | ${jobResults['âš¡ Performance Check'] || 'pending'} |
            
            ### ðŸ“ ê²€í†  ê°€ì´ë“œë¼ì¸
            
            ${jobResults['ðŸ“‹ Code Quality Check'] === 'success' ? 'âœ…' : 'âŒ'} **ì½”ë“œ í’ˆì§ˆ**: TypeScript, ESLint, Prettier ê²€ì‚¬
            ${jobResults['ðŸ—ï¸ Build & Test'] === 'success' ? 'âœ…' : 'âŒ'} **ë¹Œë“œ ê²€ì¦**: ì»´íŒŒì¼ ë° í…ŒìŠ¤íŠ¸ í†µê³¼ ì—¬ë¶€
            ${jobResults['ðŸ”’ Security Scan'] === 'success' ? 'âœ…' : 'âŒ'} **ë³´ì•ˆ ê²€ì¦**: ì˜ì¡´ì„± ì·¨ì•½ì  ë° ì½”ë“œ ë³´ì•ˆ ê²€ì‚¬
            ${jobResults['âš¡ Performance Check'] === 'success' ? 'âœ…' : 'âŒ'} **ì„±ëŠ¥ ê²€ì¦**: ë²ˆë“¤ í¬ê¸° ë° ì„±ëŠ¥ ì§€í‘œ
            
            ### ðŸ“‹ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ë¦¬ë·°ì–´ìš©)
            
            - [ ] ì½”ë“œê°€ í”„ë¡œì íŠ¸ ìŠ¤íƒ€ì¼ ê°€ì´ë“œë¥¼ ì¤€ìˆ˜í•˜ë‚˜ìš”?
            - [ ] ìƒˆë¡œìš´ ê¸°ëŠ¥ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆë‚˜ìš”?
            - [ ] ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆë‚˜ìš”?
            - [ ] Breaking changesê°€ ìžˆë‹¤ë©´ ëª…ì‹œë˜ì—ˆë‚˜ìš”?
            - [ ] ì„±ëŠ¥ì— ë¶€ì •ì ì¸ ì˜í–¥ì´ ì—†ë‚˜ìš”?
            
            ---
            ðŸ¤– *ì´ ì½”ë©˜íŠ¸ëŠ” ìžë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë” ìžì„¸í•œ ì •ë³´ëŠ” Actions íƒ­ì„ í™•ì¸í•´ì£¼ì„¸ìš”.*
            `;
            
            // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const comments = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pr_number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ðŸ¤– ìžë™ PR ê²€í†  ê²°ê³¼')
            );
            
            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr_number,
                body: comment
              });
            }

  # 6. ìžë™ ë¼ë²¨ë§
  auto-labeling:
    name: ðŸ·ï¸ Auto Labeling
    runs-on: ubuntu-latest
    needs: [code-quality, build-and-test]
    if: always()
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Add Labels
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;
            
            // PR íŒŒì¼ ë³€ê²½ì‚¬í•­ ë¶„ì„
            const files = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: pr_number,
            });
            
            const changedFiles = files.data.map(file => file.filename);
            const labels = [];
            
            // íŒŒì¼ íŒ¨í„´ì— ë”°ë¥¸ ë¼ë²¨ ì¶”ê°€
            if (changedFiles.some(file => file.includes('src/components/'))) {
              labels.push('ðŸŽ¨ UI/UX');
            }
            if (changedFiles.some(file => file.includes('src/pages/'))) {
              labels.push('ðŸ“± Pages');
            }
            if (changedFiles.some(file => file.includes('src/utils/') || file.includes('src/services/'))) {
              labels.push('ðŸ”§ Utils/Services');
            }
            if (changedFiles.some(file => file.includes('src/stores/'))) {
              labels.push('ðŸ—ƒï¸ State Management');
            }
            if (changedFiles.some(file => file.includes('.css') || file.includes('.scss'))) {
              labels.push('ðŸ’„ Styling');
            }
            if (changedFiles.some(file => file.includes('package.json'))) {
              labels.push('ðŸ“¦ Dependencies');
            }
            if (changedFiles.some(file => file.includes('.github/'))) {
              labels.push('âš™ï¸ CI/CD');
            }
            
            // ë³€ê²½ì‚¬í•­ í¬ê¸°ì— ë”°ë¥¸ ë¼ë²¨
            const totalChanges = files.data.reduce((acc, file) => acc + file.changes, 0);
            if (totalChanges < 10) {
              labels.push('ðŸ“ Small');
            } else if (totalChanges < 100) {
              labels.push('ðŸ“ Medium');  
            } else {
              labels.push('ðŸ“ Large');
            }
            
            // ë¼ë²¨ ì¶”ê°€
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: pr_number,
                labels: labels
              });
            }